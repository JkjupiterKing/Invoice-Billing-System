<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>

<app-navbar></app-navbar>

<div class="content">
  <div class="topbar">
    <div class="topbar-content">
      <p style="font-size: 30px">Invoice Management</p>
    </div>
  </div>

  <div class="button-container">
    <button class="create-btn" (click)="openInvoiceModal()">
      <i class="fas fa-plus"></i> Create Invoice
    </button>

    <div class="modal" [class.show]="isInvoiceModalOpen">
      <div class="modal-content">
        <span class="close" (click)="closeInvoiceModal()">&times;</span>
        <h2 class="form-title">Invoice Details</h2>

        <div *ngIf="successMessage" class="message success">
          <i class="fas fa-check-circle"></i> {{ successMessage }}
        </div>

        <div *ngIf="errorMessage" class="message error">
          <i class="fas fa-exclamation-triangle"></i> {{ errorMessage }}
        </div>

        <div *ngIf="loading" class="message loading">
          <i class="fas fa-spinner fa-spin"></i> Processing...
        </div>

        <form [formGroup]="invoiceForm" (ngSubmit)="onInvoiceSubmit()">
          <div class="form-row">
            <div class="form-group third-width">
              <label for="client">Select Client</label>
              <select id="client" formControlName="client" class="form-input">
                <option value="">Select Client</option>
                <option *ngFor="let client of clients" [value]="client.id">
                  {{ client.name }}
                </option>
                <option value="addNew">Add New Client</option>
              </select>
              <div *ngIf="isFieldInvalid('client')" class="error-message">
                Client selection is required
              </div>
            </div>

            <div class="form-group third-width">
              <label for="dueDate">Due Date</label>
              <input
                type="date"
                id="dueDate"
                formControlName="dueDate"
                class="form-input"
              />
              <div *ngIf="isFieldInvalid('dueDate')" class="error-message">
                Due date is required
              </div>
            </div>

            <div class="form-group third-width">
              <label for="notes">Notes</label>
              <textarea
                id="notes"
                formControlName="notes"
                class="form-input"
              ></textarea>
            </div>
          </div>

          <div class="line-items">
            <h3>Line Items</h3>
            <div
              *ngFor="let item of lineItems; let i = index"
              class="line-item"
            >
              <div class="form-group">
                <label for="itemName{{ i }}">Item Name</label>
                <input
                  type="text"
                  id="itemName{{ i }}"
                  [(ngModel)]="item.name"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label for="itemQuantity{{ i }}">Quantity</label>
                <input
                  type="number"
                  id="itemQuantity{{ i }}"
                  [(ngModel)]="item.quantity"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label for="itemRate{{ i }}">Rate</label>
                <input
                  type="number"
                  id="itemRate{{ i }}"
                  [(ngModel)]="item.rate"
                  class="form-input"
                />
              </div>
              <button
                type="button"
                (click)="removeLineItem(i)"
                class="btn-delete"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <button type="button" (click)="addLineItem()" class="create-btn">
              <i class="fas fa-plus"></i> Add Line Item
            </button>
          </div>

          <div class="form-group">
            <label>Total</label>
            <input
              type="text"
              [value]="calculateTotal()"
              class="form-input"
              readonly
            />
          </div>

          <button
            type="submit"
            [disabled]="!invoiceForm.valid || loading"
            class="submit-btn"
          >
            {{ loading ? "Processing..." : "Submit Invoice" }}
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="invoices-table">
    <table *ngIf="invoices.length > 0" class="table">
      <thead>
        <tr>
          <th>Client</th>
          <th>Total Amount</th>
          <th>Status</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of invoices">
          <td>{{ invoice.clientName }}</td>
          <!-- Use clientName here -->
          <td>{{ invoice.totalAmount | currency }}</td>
          <td>{{ invoice.status }}</td>
          <td>{{ invoice.date | date : "shortDate" }}</td>
          <td class="action-buttons">
            <button
              class="btn-delete"
              (click)="deleteInvoice(invoice.id!)"
              *ngIf="invoice.id"
            >
              <!-- Use non-null assertion operator -->
              <i class="fas fa-trash"></i> Delete
            </button>
            <button
              class="btn-download"
              (click)="downloadInvoice(invoice.id!)"
              *ngIf="invoice.id"
            >
              <!-- Use non-null assertion operator -->
              <i class="fas fa-download"></i> Download PDF
            </button>
          </td>
        </tr>
      </tbody>
    </table>
    <p *ngIf="invoices.length === 0">No invoices to show.</p>
  </div>
</div>
